<!DOCTYPE html>
<html 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/defaultLayout}">
<section layout:fragment="content" class="contents d-flex justify-content-center align-items-cener">
	<div class="whiteBox mt-4 mb-4 d-flex justify-content-center">
		<div class="h-100 detailBox">
			<!-- 제품 이미지 -->
			<img th:src="${image.imagePath}" class="productDetailImage w-100 rounded mt-3">
			
			<div class="detailBox2 w-100 d-flex">
				<!-- 제품 제목,가격 -->
				<div class="h-100 detailBox3">
					<div class="d-flex align-items-center">
						<h2 th:text="${post.subject}" class="pt-2"></h2>
						<!-- 거래전 -->
						<th:block th:if="${#strings.equals(post.state, '거래전')}">
							<h4 th:text="${post.state}" class="pt-1 pl-4 text-info"></h4>
						</th:block>
						
						<!-- 예약중 -->
						<th:block th:if="${#strings.equals(post.state, '예약중')}">
							<h4 th:text="${post.state}" class="pt-1 pl-4 text-danger"></h4>
						</th:block>
					</div>
					<h4 th:text="${post.price} + '원'" class="font-weight-bold ml-1"></h4>
				</div>
				
				<!-- 판매자 정보 -->
				<div class="h-100 w-50 d-flex">
					<!-- 판매자 프로필 사진 -->
					<div class="h-100 w-50 d-flex justify-content-center align-items-center">
						<img th:src="${writeUser.profileImagePath}" class="h-75 w-75 rounded">
					</div>
					
					<!-- 판매자 LoginId, 매너온도 -->
					<div class="h-100 w-50">
						<h5 th:text="${writeUser.loginId}" class="mt-3 ml-4"></h5>
						<h5 th:text="${writeUser.degree + '℃'}" class="ml-4"></h5>
					</div>
				</div>
			</div>
			<!-- 주소, 좋아요 버튼 -->
			<div class="detailBox4 w-100 d-flex justify-content-between align-items-center">
				<h5 th:text="${post.address}" class="ml-1"></h5>
				<a href="#" class="likeBtn" th:data-post-id="${post.id}">
					<img th:if="${filledLike == false}" src="https://www.iconninja.com/files/214/518/441/heart-icon.png" width="18" height="18" alt="empty heart" class="mr-2">
					<img th:unless="${filledLike == false}" src="https://www.iconninja.com/files/527/809/128/heart-icon.png" width="18" height="18" alt="filled heart" class="mr-2">
				</a>	
			</div>
			
			<!-- 세부사항 텍스트 박스 -->
			<textarea rows="13" class="form-control" th:text="${post.content}" readonly></textarea>
			
			<!-- 지도 -->
			
			
			<!-- 거래요청 버튼 -->
			
			<!-- 1로그인이 되어있는 경우 -->
			<th:block th:if="${session.userId != null}">
				<!-- 1-1내가 작성한 글인 경우 -->
				<th:block th:if="${session.userId == post.userId}">
					<!-- 1-1-1거래요청이 온 경우 -->
					<div th:if="${post.buyerId != null and post.isEvaluated != true}" class="d-flex justify-content-end">
						<button type="button" id="sellerSuccessExBtn" class="btn btn-secondary" th:data-post-id="${post.id}">거래완료</button>
					</div>
					
					<!-- 1-1-2거래요청이 오지 않은 경우 -->
					<div th:unless="${post.buyerId != null}" class="d-flex justify-content-end"></div>
				</th:block>
				
				<!-- 1-2내가 작성한 글이 아닌 경우 -->
				<th:block th:unless="${session.userId == post.userId}">
					<!-- 1-2-1내가 거래요청한 글인 경우 -->
					<div th:if="${session.userId == post.buyerId}" class="d-flex justify-content-end">
						<!-- 1-2-1-1 상대방이 거래완료를 아직 수락하지 않은 경우 -->
						<th:block th:if="${post.isEvaluated == false}">
							<button type="button" id="cancelExBtn" class="btn btn-danger" th:data-post-id="${post.id}">거래취소</button>
						</th:block>
						
						<!-- 1-2-1-2 상대방이 거래완료를 수락한 경우 -->
						<th:block th:unless="${post.isEvaluated == false}">
							<button type="button" id="buyerSuccessExBtn" class="btn btn-secondary" th:data-post-id="${post.id}">거래완료</button>
						</th:block>
					</div>
					
					<!-- 1-2-2거래요청하지 않은 글인 경우 -->
					<div th:unless="${session.userId == post.buyerId}" class="d-flex justify-content-end">
						<!-- 1-2-2-1예약자가 있는 경우 -->
						<th:block th:if="${post.buyerId != null}"></th:block>
						
						<!-- 1-2-2-2예약자가 없는 경우 -->
						<th:block th:unless="${post.buyerId != null}">
							<button type="button" id="requestExBtn" class="btn btn-info" th:data-user-id="${session.userId}" th:data-post-id="${post.id}">거래요청</button>
						</th:block>
					</div>
				</th:block>
			</th:block>
			
			<!-- 2로그인이 되어있지 않은 경우 -->
			<th:block th:unless="${session.userId != null}"></th:block>
		</div>
	</div>
</section>

<th:block layout:fragment="script">
    <script>
		$(document).ready(function() {
			// 좋아요 클릭
			$(".likeBtn").on('click', function(e) {
				e.preventDefault();
				
				let postId = $(this).data("post-id");
				//alert(postId);
				
				$.ajax({
					url:"/like/" + postId
					, success:function(data) {
						if (data.code == 200) {
							location.reload();
						} else if (data.code == 403) {
							alert(data.error_message);
							location.href = "/user/sign-in-view";
						}
					}
					, error:function(e) {
						alert("좋아요를 하는데 실패했습니다.");
					}
				});
			}); // --- 좋아요 클릭 끝
			// 거래요청 클릭
			$("#requestExBtn").on('click', function() {
				//alert("거래요청");
				
				let postId = $(this).data("post-id");
				//console.log(postId);
				
				$.ajax({
					type:"post"
					, url:"/post/buy-request"
					, data:{"postId":postId}
					, success:function(data) {
						if (data.code == 200) {
							alert("거래요청이 완료되었습니다.");
							location.reload(true);
						} else if (data.code == 403) {
							alert(data.error_message);
							location.href = "/user/sign-in-view";
						} else {
							alert(data.error_message);
						}
					}
					, error:function(e) {
						alert("거래요청에 실패했습니다.");
					}
				});
			}); // --- 거래요청 버튼 클릭 끝
			// 거래취소 버튼 클릭
			$("#cancelExBtn").on('click', function() {
				//alert("거래취소 버튼 클릭");
				let postId = $(this).data("post-id");
				
				$.ajax({
					type:"post"
					, url:"/post/refund-request"
					, data:{"postId":postId}
					, success:function(data) {
						if (data.code == 200) {
							alert("거래요청이 취소되었습니다.");
							location.reload(true);
						} else if (data.code == 403) {
							alert(data.error_message);
							location.href = "/user/sign-in-view";
						} else {
							alert(data.error_message);
						}
					}
					, error:function(e) {
						alert("거래취소 요청에 실패했습니다.");
					} 
				});
			}); // --- 거래취소 버튼 클릭 끝
			
			// 판매자 거래완료 버튼 클릭
			$("#sellerSuccessExBtn").on('click', function() {
				//alert("거래완료 버튼 클릭");
				let postId = $(this).data("post-id");
				
				$.ajax({
					type:"post"
					, url:"/post/update-isEvaluated"
					, data:{"postId":postId}
					, success:function(data) {
						if (data.code == 200) {
							alert("거래가 완료되었습니다.");
							location.href="/user/evaluate-view?traderId=" + data.buyerId;
						} else if (data.code == 403) {
							alert(data.error_message);
							location.href = "/user/sign-in-view";
						} else {
							alert(data.error_message);
						}
					}
					, error:function(e) {
						alert("거래완료에 실패했습니다.");
					} 
				});
			}); // --- 판매자 거래완료 버튼 클릭 끝
			// 구매자 거래완료 버튼 클릭
			$("#buyerSuccessExBtn").on('click', function() {
				//alert("거래완료 버튼 클릭");
				let postId = $(this).data("post-id");
				
				$.ajax({
					type:"post"
					, url:"/post/delete-post"
					, data:{"postId":postId}
					, success:function(data) {
						if (data.code == 200) {
							alert("거래가 완료되었습니다.");
							location.href="/user/evaluate-view?traderId=" + data.userId;
						} else if (data.code == 403) {
							alert(data.error_message);
							location.href = "/user/sign-in-view";
						} else {
							alert(data.error_message);
						}
					}
					, error:function(e) {
						alert("거래완료에 실패했습니다.");
					} 
				});
			}); // --- 판매자 거래완료 버튼 클릭 끝
		});
    </script>
</th:block>